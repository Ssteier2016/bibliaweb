import React, { useState, useEffect } from 'react';
import * as tf from '@tensorflow/tfjs';
import * as nsfwjs from 'nsfwjs';
import './ContentFilter.css';

const ContentFilter = () => {
  const [model, setModel] = useState(null);
  const [stats, setStats] = useState({ explicitCount: 0, lastDetected: null });
  const [verse, setVerse] = useState('');

  // Cargar el modelo NSFW.js al montar el componente
  useEffect(() => {
    async function loadModel() {
      await tf.ready();
      const loadedModel = await nsfwjs.load('/models/nsfwjs/');
      setModel(loadedModel);
    }
    loadModel();
  }, []);

  // Manejar la carga de imágenes (por ejemplo, desde un input)
  const handleImageUpload = async (event) => {
    if (!model) return;

    const file = event.target.files[0];
    const img = new Image();
    img.src = URL.createObjectURL(file);

    img.onload = async () => {
      const predictions = await model.classify(img);
      const isExplicit = predictions.some(
        (pred) => pred.className === 'Porn' && pred.probability > 0.8
      );

      if (isExplicit) {
        setStats((prev) => ({
          explicitCount: prev.explicitCount + 1,
          lastDetected: new Date().toLocaleString(),
        }));
        // Sugerir un versículo motivacional
        setVerse('“Todo lo puedo en Cristo que me fortalece.” - Filipenses 4:13');
        alert('Contenido explícito detectado. Te sugerimos leer: ' + verse);
      } else {
        alert('Contenido seguro.');
      }
    };
  };

  return (
    <div className="content-filter">
      <h2>Filtro de Bienestar</h2>
      <p>Sube una imagen para verificar si es adecuada:</p>
      <input type="file" accept="image/*" onChange={handleImageUpload} />
      <div className="stats">
        <p>Contenido explícito detectado: {stats.explicitCount} veces</p>
        <p>Última detección: {stats.lastDetected || 'Ninguna'}</p>
        {verse && <p>Versículo sugerido: {verse}</p>}
      </div>
    </div>
  );
};

export default ContentFilter;
